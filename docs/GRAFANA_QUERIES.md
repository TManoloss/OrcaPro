# üìä Grafana - Queries e Dashboards

Guia completo de queries √∫teis para monitoramento dos microsservi√ßos.

## üéØ Prometheus Queries

### HTTP Metrics

#### Taxa de Requisi√ß√µes por Segundo
```promql
# Por servi√ßo
rate(http_requests_total[5m])

# Por servi√ßo e endpoint
sum by(service, path) (rate(http_requests_total[5m]))

# Total geral
sum(rate(http_requests_total[5m]))
```

#### Taxa de Erros
```promql
# Percentual de erros 5xx
sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) * 100

# Erros por servi√ßo
sum by(service) (rate(http_requests_total{status=~"5.."}[5m]))

# Erros 4xx vs 5xx
sum by(status) (rate(http_requests_total{status=~"[45].."}[5m]))
```

#### Lat√™ncia (Percentis)
```promql
# P50 (mediana)
histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))

# P95
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# P99
histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

# Por endpoint
histogram_quantile(0.95, sum by(path, le) (rate(http_request_duration_seconds_bucket[5m])))
```

#### Requisi√ß√µes mais lentas
```promql
# Top 5 endpoints mais lentos (P95)
topk(5, histogram_quantile(0.95, sum by(path, le) (rate(http_request_duration_seconds_bucket[5m]))))
```

### Business Metrics

#### Auth Service
```promql
# Total de usu√°rios registrados
user_registrations_total

# Taxa de registros por hora
increase(user_registrations_total[1h])

# Taxa de logins bem-sucedidos
rate(user_logins_total[5m])

# Taxa de tentativas de login falhas
rate(failed_login_attempts_total[5m])

# Ratio de falhas de login
rate(failed_login_attempts_total[5m]) / rate(user_logins_total[5m])

# Sess√µes ativas
active_sessions

# Tokens gerados por minuto
rate(jwt_tokens_generated_total[1m]) * 60

# Taxa de sucesso de valida√ß√£o de tokens
rate(jwt_tokens_validated_total{result="success"}[5m]) / rate(jwt_tokens_validated_total[5m]) * 100
```

#### Transaction Service
```promql
# Total de transa√ß√µes criadas
transactions_created_total

# Transa√ß√µes criadas por tipo
sum by(type) (transactions_created_total)

# Transa√ß√µes criadas por categoria
sum by(category) (transactions_created_total)

# Taxa de cria√ß√£o de transa√ß√µes
rate(transactions_created_total[5m])

# Transa√ß√µes criadas na √∫ltima hora
increase(transactions_created_total[1h])

# Transa√ß√µes atualizadas
transactions_updated_total

# Transa√ß√µes deletadas
transactions_deleted_total

# Distribui√ß√£o de valores de transa√ß√µes
histogram_quantile(0.95, rate(transaction_amount_bucket[5m]))
```

### RabbitMQ Metrics
```promql
# Mensagens publicadas com sucesso
rate(rabbitmq_messages_published_total{status="success"}[5m])

# Taxa de erros de publica√ß√£o
rate(rabbitmq_messages_published_total{status="error"}[5m])

# Percentual de sucesso
rate(rabbitmq_messages_published_total{status="success"}[5m]) / rate(rabbitmq_messages_published_total[5m]) * 100

# Lat√™ncia de publica√ß√£o (P95)
histogram_quantile(0.95, rate(rabbitmq_message_publish_duration_seconds_bucket[5m]))

# Status da conex√£o (1=conectado, 0=desconectado)
rabbitmq_connection_status

# Mensagens por routing key
sum by(routing_key) (rate(rabbitmq_messages_published_total[5m]))
```

### Database Metrics
```promql
# Conex√µes ativas
database_connections_active

# Lat√™ncia de queries (P95)
histogram_quantile(0.95, rate(database_query_duration_seconds_bucket[5m]))

# Queries mais lentas por tipo
topk(5, histogram_quantile(0.95, sum by(query_type, le) (rate(database_query_duration_seconds_bucket[5m]))))
```

### Redis Metrics
```promql
# Lat√™ncia de opera√ß√µes no Redis (P95)
histogram_quantile(0.95, rate(redis_operation_duration_seconds_bucket[5m]))

# Opera√ß√µes por segundo
rate(redis_operation_duration_seconds_count[5m])
```

## üìà Dashboards Recomendados

### Dashboard 1: Overview Geral

**Linha 1: Golden Signals**
- Taxa de Requisi√ß√µes (gauge)
- Taxa de Erros (gauge)
- Lat√™ncia P95 (gauge)
- Satura√ß√£o - Conex√µes DB (gauge)

**Linha 2: Gr√°ficos de Tempo**
- Requisi√ß√µes/s por servi√ßo (graph)
- Taxa de erros ao longo do tempo (graph)
- Lat√™ncia P50/P95/P99 (graph)

**Linha 3: Business Metrics**
- Usu√°rios registrados (stat)
- Logins/hora (stat)
- Transa√ß√µes criadas/hora (stat)
- Sess√µes ativas (stat)

### Dashboard 2: Auth Service

```json
{
  "panels": [
    {
      "title": "Registros de Usu√°rios",
      "targets": [{
        "expr": "user_registrations_total"
      }]
    },
    {
      "title": "Taxa de Logins (req/s)",
      "targets": [{
        "expr": "rate(user_logins_total[5m])"
      }]
    },
    {
      "title": "Tentativas de Login Falhas",
      "targets": [{
        "expr": "rate(failed_login_attempts_total[5m])"
      }]
    },
    {
      "title": "Sess√µes Ativas",
      "targets": [{
        "expr": "active_sessions"
      }]
    },
    {
      "title": "Lat√™ncia de Requisi√ß√µes",
      "targets": [
        {
          "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket{service=\"auth-service\"}[5m]))",
          "legendFormat": "P50"
        },
        {
          "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{service=\"auth-service\"}[5m]))",
          "legendFormat": "P95"
        },
        {
          "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{service=\"auth-service\"}[5m]))",
          "legendFormat": "P99"
        }
      ]
    }
  ]
}
```

### Dashboard 3: Transaction Service

```promql
# Panel 1: Transa√ß√µes Criadas por Tipo
sum by(type) (transactions_created_total)

# Panel 2: Transa√ß√µes por Categoria (Top 10)
topk(10, sum by(category) (transactions_created_total))

# Panel 3: Taxa de Cria√ß√£o de Transa√ß√µes
rate(transactions_created_total[5m])

# Panel 4: Distribui√ß√£o de Valores
histogram_quantile(0.50, rate(transaction_amount_bucket[5m]))

# Panel 5: RabbitMQ - Mensagens Publicadas
rate(rabbitmq_messages_published_total{status="success"}[5m])

# Panel 6: Lat√™ncia do RabbitMQ
histogram_quantile(0.95, rate(rabbitmq_message_publish_duration_seconds_bucket[5m]))
```

### Dashboard 4: RabbitMQ Deep Dive

```promql
# Panel 1: Taxa de Publica√ß√£o por Routing Key
sum by(routing_key) (rate(rabbitmq_messages_published_total[5m]))

# Panel 2: Taxa de Erros
rate(rabbitmq_messages_publish_errors_total[5m])

# Panel 3: Status da Conex√£o
rabbitmq_connection_status

# Panel 4: Lat√™ncia de Publica√ß√£o (percentis)
histogram_quantile(0.50, rate(rabbitmq_message_publish_duration_seconds_bucket[5m]))
histogram_quantile(0.95, rate(rabbitmq_message_publish_duration_seconds_bucket[5m]))
histogram_quantile(0.99, rate(rabbitmq_message_publish_duration_seconds_bucket[5m]))
```

## üîç Loki Queries (LogQL)

### Queries B√°sicas

```logql
# Todos os logs de um servi√ßo
{service="auth-service"}

# Logs de m√∫ltiplos servi√ßos
{service=~"auth-service|transaction-service"}

# Logs de erro
{} |= "error"

# Logs com level espec√≠fico (JSON)
{} | json | level="error"

# Logs de um usu√°rio espec√≠fico
{} | json | user_id="abc-123"
```

### Queries Avan√ßadas

```logql
# Logs de um trace_id espec√≠fico
{} | json | trace_id="4bf92f3577b34da6a3ce929d0e0e4736"

# Logs de cria√ß√£o de transa√ß√µes
{service="transaction-service"} |= "transaction created"

# Logs de autentica√ß√£o
{service="auth-service"} |= "logged in" or "login failed"

# Rate de erros nos √∫ltimos 5 minutos
rate({} | json | level="error" [5m])

# Count de erros agrupados por servi√ßo
sum by(service) (count_over_time({} | json | level="error" [5m]))

# Logs com lat√™ncia alta
{} | json | duration > 1s

# Logs de um endpoint espec√≠fico
{} | json | path="/api/v1/transactions"

# Pattern extraction
{service="auth-service"} | pattern "<_> user_id=<user_id> <_>"
```

### Queries para Debugging

```logql
# Erros de conex√£o com banco
{} |~ "(?i)database.*error|connection.*refused"

# Erros do RabbitMQ
{service="transaction-service"} |= "rabbitmq" |= "error"

# Requests lentas (> 1 segundo)
{} | json | latency > "1s"

# Failed login attempts
{service="auth-service"} |= "invalid password" or "user not found"

# Todos os eventos de uma requisi√ß√£o (usando trace_id)
{} | json | trace_id="abc123" | line_format "{{.timestamp}} [{{.level}}] {{.service}} - {{.message}}"
```

### Agrega√ß√µes e Estat√≠sticas

```logql
# Contagem de logs por n√≠vel
sum by(level) (count_over_time({} | json [5m]))

# Top 10 endpoints com mais erros
topk(10, sum by(path) (count_over_time({} | json | level="error" [1h])))

# Lat√™ncia m√©dia por endpoint
avg_over_time({} | json | unwrap latency [5m]) by (path)

# Rate de logs por servi√ßo
sum by(service) (rate({} [5m]))
```

## üìä Alertas Importantes

### Alertas de SLA

```yaml
# Alert 1: Alta taxa de erros (> 5%)
groups:
  - name: sla_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) * 100 > 5
        for: 2m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Alta taxa de erros detectada"
          description: "{{ $value }}% das requisi√ß√µes est√£o falhando"

      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            rate(http_request_duration_seconds_bucket[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Lat√™ncia P95 acima de 1 segundo"
          description: "P95 est√° em {{ $value }}s"

      - alert: ServiceDown
        expr: up{job=~"auth-service|transaction-service"} == 0
        for: 1m
        labels:
          severity: critical
          team: sre
        annotations:
          summary: "Servi√ßo {{ $labels.job }} est√° down"
          description: "O servi√ßo n√£o est√° respondendo"
```

### Alertas de Neg√≥cio

```yaml
      - alert: NoUserRegistrations
        expr: |
          increase(user_registrations_total[1h]) == 0
        for: 2h
        labels:
          severity: warning
          team: product
        annotations:
          summary: "Sem registros de usu√°rios nas √∫ltimas 2 horas"
          description: "Poss√≠vel problema no fluxo de cadastro"

      - alert: HighLoginFailureRate
        expr: |
          (
            rate(failed_login_attempts_total[5m])
            /
            rate(user_logins_total[5m])
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          team: security
        annotations:
          summary: "Alta taxa de falhas de login"
          description: "{{ $value }}% dos logins est√£o falhando"

      - alert: RabbitMQPublishErrors
        expr: |
          rate(rabbitmq_messages_publish_errors_total[5m]) > 0
        for: 2m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Erros ao publicar mensagens no RabbitMQ"
          description: "Taxa de erros: {{ $value }}/s"
```

### Alertas de Infraestrutura

```yaml
      - alert: DatabaseConnectionsHigh
        expr: database_connections_active > 80
        for: 5m
        labels:
          severity: warning
          team: dba
        annotations:
          summary: "N√∫mero alto de conex√µes no banco"
          description: "{{ $value }} conex√µes ativas"

      - alert: RedisDown
        expr: redis_operation_duration_seconds_count == 0
        for: 2m
        labels:
          severity: critical
          team: sre
        annotations:
          summary: "Redis n√£o est√° respondendo"
          description: "Sem opera√ß√µes no Redis nos √∫ltimos 2 minutos"

      - alert: RabbitMQDisconnected
        expr: rabbitmq_connection_status == 0
        for: 1m
        labels:
          severity: critical
          team: sre
        annotations:
          summary: "Conex√£o com RabbitMQ perdida"
          description: "Servi√ßo {{ $labels.service }} desconectado do RabbitMQ"
```

## üé® Templates de Pain√©is Grafana

### Painel: Taxa de Requisi√ß√µes com Threshold

```json
{
  "type": "graph",
  "title": "Request Rate",
  "targets": [
    {
      "expr": "sum(rate(http_requests_total[5m]))",
      "legendFormat": "Total Requests/s"
    }
  ],
  "thresholds": [
    {
      "value": 100,
      "colorMode": "custom",
      "fill": true,
      "line": true,
      "op": "gt",
      "fillColor": "rgba(255, 0, 0, 0.1)",
      "lineColor": "rgb(255, 0, 0)"
    }
  ]
}
```

### Painel: Heatmap de Lat√™ncia

```json
{
  "type": "heatmap",
  "title": "Request Latency Distribution",
  "targets": [
    {
      "expr": "sum(rate(http_request_duration_seconds_bucket[5m])) by (le)",
      "format": "heatmap",
      "legendFormat": "{{le}}"
    }
  ]
}
```

### Painel: Status dos Servi√ßos (Stat)

```json
{
  "type": "stat",
  "title": "Services Status",
  "targets": [
    {
      "expr": "up{job=~\"auth-service|transaction-service\"}",
      "legendFormat": "{{job}}"
    }
  ],
  "options": {
    "reduceOptions": {
      "values": false,
      "calcs": ["lastNotNull"]
    },
    "colorMode": "background",
    "graphMode": "none"
  },
  "fieldConfig": {
    "defaults": {
      "mappings": [
        {
          "type": "value",
          "options": {
            "0": { "text": "DOWN", "color": "red" },
            "1": { "text": "UP", "color": "green" }
          }
        }
      ]
    }
  }
}
```

## üîó Correlacionando Dados

### Logs ‚Üí Traces ‚Üí Metrics

**1. Come√ßar com um erro nos logs:**
```logql
{service="transaction-service"} | json | level="error" | trace_id!=""
```

**2. Pegar o trace_id e buscar no Jaeger:**
```
http://localhost:16686/trace/{trace_id}
```

**3. Ver m√©tricas do per√≠odo:**
```promql
rate(http_requests_total{status="500"}[5m])
```

### Exemplo de Workflow de Investiga√ß√£o

**Cen√°rio: API lenta**

1. **Verificar lat√™ncia no Prometheus:**
```promql
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{path="/api/v1/transactions"}[5m]))
```

2. **Ver logs do per√≠odo no Loki:**
```logql
{service="transaction-service", path="/api/v1/transactions"} 
| json 
| duration > 1s
```

3. **Pegar trace_id de uma request lenta e investigar no Jaeger**

4. **Verificar se h√° problema no banco:**
```promql
histogram_quantile(0.95, rate(database_query_duration_seconds_bucket[5m]))
```

5. **Verificar RabbitMQ:**
```promql
rate(rabbitmq_messages_publish_errors_total[5m])
```

## üì± Vari√°veis de Dashboard

### Vari√°vel: Service
```
Query: label_values(http_requests_total, service)
```

### Vari√°vel: Endpoint
```
Query: label_values(http_requests_total{service="$service"}, path)
```

### Vari√°vel: Time Range
```
Custom: 5m, 15m, 1h, 6h, 24h, 7d
```

### Uso em Queries
```promql
rate(http_requests_total{service="$service", path="$endpoint"}[$__rate_interval])
```

## üéØ Cheat Sheet R√°pido

### Top Queries mais √öteis

```promql
# 1. Taxa de requisi√ß√µes
sum(rate(http_requests_total[5m])) by (service)

# 2. Taxa de erros
sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)

# 3. Lat√™ncia P95
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# 4. Transa√ß√µes por tipo
sum by(type) (transactions_created_total)

# 5. Status do RabbitMQ
rabbitmq_connection_status
```

### Top Loki Queries

```logql
# 1. Erros recentes
{} | json | level="error" | line_format "{{.timestamp}} {{.service}} - {{.message}}"

# 2. Logs de um trace
{} | json | trace_id="abc123"

# 3. Rate de erros
rate({} | json | level="error" [5m])

# 4. Top servi√ßos com erros
topk(5, sum by(service) (count_over_time({} | json | level="error" [1h])))

# 5. Requests lentas
{} | json | duration > 1s
```

---

**üí° Dica**: Salve seus dashboards favoritos como JSON para versionamento no Git!